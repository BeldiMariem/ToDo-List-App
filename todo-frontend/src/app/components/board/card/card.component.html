<div cdkDrag class="card" [style.borderTopColor]="color">
  <div class="card-content">
    <button class="card-delete-btn" (click)="onDelete()" title="Delete Task">
      <i class="fas fa-times"></i>
    </button>

    <div class="card-tags">
      <span class="tag">backend</span>
    </div>
    <h4>{{ card.title }}</h4>
    <p>{{ card.description }}</p>
    <div class="card-footer">
      <div class="card-meta">
        <span
          class="meta-item comment-toggle"
          (click)="onToggleComments()"
          [class.active]="isCommentsOpen"
        >
          <i class="far fa-comment"></i> {{ card.comments!.length || 0 }}
        </span>

        <button class="meta-item" (click)="delete.emit(card.id)">
          <i class="fas fa-trash"></i>
        </button>
      </div>

      @if (card.members && card.members.length > 0) {
        <div class="assignee">
          <div class="member-avatars">
            @for (member of card.members; track member; let idx = $index) {
              @if (idx < 3) {
                <div class="member-avatar">
                  <img
                    [src]="getUserAvatar(getMemberUser(member))"
                    [alt]="getMemberUser(member).username"
                    [title]="getMemberUser(member).username"
                  />
                </div>
              }
            }
            @if (card.members.length > 3) {
              <div class="member-count">
                +{{ card.members.length - 3 }}
              </div>
            }
          </div>
        </div>
      }
    </div>

    @if (isCommentsOpen) {
      <div class="comments-section">
        <div class="comments-header">
          <i class="far fa-comment"></i>
          <span>{{ card.comments!.length || 0 }} comment(s)</span>
          <button
            class="btn-close-comments"
            (click)="onToggleComments()"
            title="Close comments"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>

        @if (card.comments && card.comments.length > 0) {
          <div class="comments-list">
            @for (comment of card.comments; track comment.id) {
              <div class="comment">
                <div class="comment-header">
                  <img
                    [src]="getUserAvatar(comment.user)"
                    class="comment-avatar"
                    alt="User"
                  />
                  <span class="comment-author">{{ comment.user.username }}</span>
                  <span class="comment-date">{{ formatDate(comment.createdAt) }}</span>
                </div>
                <p class="comment-content">{{ comment.content }}</p>

                @if (canModifyComment(comment)) {
                  <button
                    class="btn-icon btn-delete"
                    (click)="onDeleteComment(comment.id)"
                    title="Delete comment"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                }
              </div>
            }
          </div>
        }

        <div class="add-comment-form">
          <textarea
            placeholder="Add a comment..."
            [(ngModel)]="card.newComment"
            class="comment-input"
            (keydown.enter)="$event.preventDefault(); onAddComment()"
          ></textarea>
          <button
            class="btn-add-comment"
            (click)="onAddComment()"
            [disabled]="!card.newComment!.trim()"
          >
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    }
  </div>
</div>
